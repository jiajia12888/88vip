<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 调试面板</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/tailwindcss-browser/4.1.13/index.global.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
    <style>
        @import url('https://font.webcache.cn/google/css2?family=JetBrains+Mono:wght@400;600&family=Manrope:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-1: #eef3f8;
            --bg-2: #f9fbfe;
            --surface: rgba(255, 255, 255, 0.88);
            --surface-strong: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --accent: #007aff;
            --accent-glow: rgba(0, 122, 255, 0.2);
            --border: rgba(15, 23, 42, 0.12);
            --shadow: 0 24px 60px rgba(15, 23, 42, 0.18);
            --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.12);
            --radius: 22px;
        }

        * {
            box-sizing: border-box;
        }

        body.app-body {
            margin: 0;
            background: radial-gradient(circle at 15% 20%, rgba(0, 122, 255, 0.18), transparent 40%),
                radial-gradient(circle at 85% 10%, rgba(52, 199, 89, 0.16), transparent 45%),
                linear-gradient(140deg, var(--bg-1), var(--bg-2));
            color: var(--text);
            font-family: "Manrope", "SF Pro Text", "SF Pro Display", sans-serif;
            -webkit-font-smoothing: antialiased;
            scroll-behavior: smooth;
        }

        .app-shell {
            padding: clamp(16px, 2.5vw, 28px);
        }

        .panel-card {
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(18px);
            animation: panelRise 0.6s ease-out;
        }

        #message-output {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 16px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        #log-output {
            background: linear-gradient(180deg, #0f172a, #111827);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.5);
            font-family: "JetBrains Mono", "Fira Code", monospace;
        }

        input[type="text"],
        textarea {
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 8px 16px rgba(15, 23, 42, 0.06);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
            transform: translateY(-1px);
        }

        button {
            border-radius: 12px;
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        button:hover {
            transform: translateY(-1px);
        }

        a {
            color: var(--accent);
        }

        @keyframes panelRise {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body class="app-body">
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 app-shell">
        <div class="bg-white rounded-2xl shadow-lg p-6 panel-card">
            <div class="flex justify-between items-center pb-4 mb-6 border-b border-gray-200">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">WebSocket 调试面板</h1>
                <a href="/admin" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors">返回管理面板</a>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3">在线客户端 (<span id="client-count">0</span>)</h2>
                        <ul id="client-list" class="bg-gray-50 border rounded-lg max-h-64 overflow-y-auto p-2 space-y-1"></ul>
                        <button id="refresh-btn" class="mt-2 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 text-sm font-semibold">手动刷新</button>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-3">发送指令</h2>
                        <form id="send-form" class="space-y-3">
                            <div>
                                <label for="target-client" class="block text-sm font-medium text-gray-700">目标客户端:</label>
                                <input type="text" id="target-client" readonly required class="mt-1 w-full p-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="target-user-id">
                            </div>
                            <div>
                                <label for="payload" class="block text-sm font-medium text-gray-700">消息内容 (JSON格式):</label>
                                <textarea id="payload" required class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm h-40">{
    "type": 5000,
    "data": {
      "conversation_id": "S:1234567",
      "content": "你好"
    }
}</textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">发送消息</button>
                        </form>
                        <div id="status" class="mt-3 text-sm font-medium text-center p-2 rounded-md"></div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3">接收的消息</h2>
                        <div id="message-output" class="h-80 bg-gray-100 rounded-lg p-3 space-y-3 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold mb-3">实时日志</h2>
                        <div id="log-output" class="h-80 bg-gray-900 text-gray-300 rounded-lg p-4 font-mono text-xs leading-relaxed overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const clientListElem = document.getElementById('client-list');
        const clientCountElem = document.getElementById('client-count');
        const targetClientInput = document.getElementById('target-client');
        const targetUserIdInput = document.getElementById('target-user-id');
        const sendForm = document.getElementById('send-form');
        const statusElem = document.getElementById('status');
        const logOutput = document.getElementById('log-output');
        const messageOutput = document.getElementById('message-output');
        const refreshBtn = document.getElementById('refresh-btn');

        function renderClientList(allClientsData) {
            const currentTarget = targetClientInput.value;
            clientListElem.innerHTML = '';
            const onlineClients = allClientsData.filter(c => c.online);
            clientCountElem.innerText = onlineClients.length;

            if (onlineClients.length > 0) {
                onlineClients.forEach(client => {
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-md cursor-pointer transition hover:bg-gray-200 border border-transparent';
                    li.dataset.clientId = client.client_id;
                    li.dataset.userId = client.user_id;
                    li.innerHTML = `<div class="font-bold text-sm text-gray-800">${client.myNick || '未知昵称'} (${client.user_id})</div><div class="text-xs text-gray-500 truncate">${client.client_id}</div>`;
                    li.onclick = () => {
                        document.querySelectorAll('#client-list li').forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-400'));
                        li.classList.add('bg-indigo-100', 'border-indigo-400');
                        targetClientInput.value = client.client_id;
                        targetUserIdInput.value = client.user_id;
                    };
                    clientListElem.appendChild(li);
                });
                const targetLi = Array.from(clientListElem.querySelectorAll('li')).find(li => li.dataset.clientId === currentTarget);
                if (targetLi) {
                    targetLi.classList.add('bg-indigo-100', 'border-indigo-400');
                    targetUserIdInput.value = targetLi.dataset.userId;
                } else if (clientListElem.firstChild) {
                    clientListElem.firstChild.click();
                }
            } else {
                clientListElem.innerHTML = '<li class="text-center text-gray-500 p-4">没有在线的客户端</li>';
                targetClientInput.value = '';
                targetUserIdInput.value = '';
            }
        }

        function processFullUpdate(data) {
            let allClients = [].concat(data.unassigned || []);
            if (data.assigned) {
                for (const user in data.assigned) {
                    allClients = allClients.concat(data.assigned[user]);
                }
            }
            renderClientList(allClients);
        }
        
        refreshBtn.onclick = async () => {
            try {
                const response = await fetch('/api/data');
                if (response.status === 401) { window.location.href = '/'; return; }
                const data = await response.json();
                processFullUpdate(data);
                showStatus('列表已手动刷新', 'success');
            } catch(e) { showStatus('手动刷新失败', 'error'); }
        };

        sendForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const clientId = targetClientInput.value;
            const userId = targetUserIdInput.value;
            let payload;
            try {
                payload = JSON.parse(document.getElementById('payload').value);
            } catch (error) {
                showStatus(`JSON 格式错误: ${error.message}`, 'error');
                return;
            }
            if (!clientId || !userId) {
                showStatus('请先从列表中选择一个客户端', 'error');
                return;
            }
            try {
                const response = await fetch('/api/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: clientId, payload: payload, user_id: userId })
                });
                const result = await response.json();
                showStatus(result.message, result.success ? 'success' : 'error');
            } catch (error) {
                showStatus(`发送请求失败: ${error}`, 'error');
            }
        });

        function showStatus(message, type) {
            statusElem.textContent = message;
            statusElem.className = 'mt-3 text-sm font-medium text-center p-2 rounded-md';
            if (type === 'success') {
                statusElem.classList.add('bg-green-100', 'text-green-800');
            } else {
                statusElem.classList.add('bg-red-100', 'text-red-800');
            }
        }

        function connectLogs() {
            const logSocket = new WebSocket(`ws://${window.location.host}/ws?client_type=viewer`);
            logSocket.onopen = () => appendLogMessage({payload: {message: "调试WebSocket连接成功."}});
            
            logSocket.onmessage = (event) => {
                try {
                    const eventData = JSON.parse(event.data);
                    if (eventData.type === 'log') {
                        appendLogMessage(eventData);
                        if (eventData.payload.is_message) {
                            appendIncomingMessage(eventData);
                        }
                    } else if (eventData.type === 'full_update') {
                        processFullUpdate(eventData.payload);
                    }
                } catch (e) { console.error("无法解析事件消息:", event.data); }
            };

            logSocket.onclose = () => {
                appendLogMessage({payload: {message: "调试WebSocket已断开，3秒后尝试重连..."}});
                setTimeout(connectLogs, 3000);
            };
            logSocket.onerror = () => appendLogMessage({payload: {message: "调试WebSocket连接出错."}});
        }
        
        function appendLogMessage(eventData) {
            const timestamp = new Date(eventData.timestamp || Date.now()).toLocaleTimeString();
            const messageDiv = document.createElement('div');
            const message = eventData.payload.message;
            let color = 'text-gray-300';
            if (message.includes("已连接")) color = 'text-green-400';
            if (message.includes("已断开")) color = 'text-red-400';
            if (message.includes("心跳")) color = 'text-blue-400';
            
            const timeSpan = `<span class="text-gray-500">[${timestamp}]</span>`;
            const messageSpan = `<span class="${color}">${message}</span>`;
            messageDiv.innerHTML = `${timeSpan} ${messageSpan}`;
            
            logOutput.appendChild(messageDiv);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function appendIncomingMessage(eventData) {
            const timestamp = new Date(eventData.timestamp || Date.now()).toLocaleTimeString();
            const fullMessage = eventData.payload.message;
            const match = fullMessage.match(/<- 来自 (.*?)\s\((.*?)\) 的消息: (.*)/s);
            if (match) {
                const [, clientId, userId, content] = match;
                const messageContainer = document.createElement('div');
                messageContainer.className = 'bg-white p-3 rounded-lg shadow-sm';
                
                const header = `<div class="text-xs font-bold text-gray-800">${userId} <span class="font-normal text-gray-500">(${clientId}) @ ${timestamp}</span></div>`;
                
                let formattedContent = '';
                try {
                    const jsonObject = JSON.parse(content);
                    formattedContent = JSON.stringify(jsonObject, null, 2);
                } catch(e) {
                    formattedContent = content;
                }
                
                const body = `<pre class="text-sm text-gray-700 whitespace-pre-wrap break-all">${formattedContent}</pre>`;
                
                messageContainer.innerHTML = header + body;
                messageOutput.appendChild(messageContainer);
                messageOutput.scrollTop = messageOutput.scrollHeight;
            }
        }
        
        refreshBtn.onclick();
        connectLogs();
    </script>
</body>
</html>
